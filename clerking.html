<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBM TOOLKIT v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.1.0/build/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .input-field { background-color: #ffffff; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="py-8 px-4">

    <div class="max-w-5xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-teal-500">
                <p class="text-xs font-bold text-slate-500 uppercase">Total Patients</p>
                <h3 id="dashTotal" class="text-2xl font-black text-slate-800">--</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-xs font-bold text-slate-500 uppercase">High Risk (ASSIST)</p>
                <h3 id="dashHighRisk" class="text-2xl font-black text-red-600">--</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-xs font-bold text-slate-500 uppercase">Quick Search</p>
                <div class="flex mt-1">
                    <input type="text" id="searchQuery" placeholder="Name/IC..." class="text-xs p-2 border rounded-l-md w-full outline-none">
                    <button onclick="searchPatient()" class="bg-blue-600 text-white px-3 py-1 rounded-r-md text-xs font-bold hover:bg-blue-700">Find</button>
                </div>
            </div>
        </div>

        <div class="bg-white shadow-2xl rounded-2xl overflow-hidden border border-slate-200">
            <header class="bg-teal-800 text-white p-6 text-center">
                <h1 class="text-3xl font-black tracking-tight">KBM TOOLKIT v4.0</h1>
                <p class="text-teal-100 opacity-90 mt-1">Clinical Tobacco & Vape Cessation Tool</p>
            </header>

            <form id="clerkingForm" class="p-8 space-y-10">
                
                <section class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Full Name</label>
                        <input type="text" id="ptName" name="ptName" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-1">IC / Passport</label>
                        <input type="text" id="ptIC" name="ptIC" class="input-field font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Visit Number</label>
                        <input type="number" id="visitNo" name="visitNo" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Quit Date</label>
                        <input type="date" id="quitDate" name="quitDate" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Date of Visit</label>
                        <input type="date" id="visitDate" name="visitDate" class="input-field">
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="border rounded-2xl overflow-hidden shadow-sm">
                        <div class="bg-blue-700 text-white px-5 py-3 flex justify-between items-center">
                            <span class="font-bold uppercase tracking-wider text-sm">Fagerstr√∂m (Cigarette)</span>
                            <span id="fagResultDisplay" class="font-black text-lg">0 (Very Low)</span>
                            <input type="hidden" id="fagerstrom" name="fagerstrom" value="0 (Very Low)">
                        </div>
                        <div class="p-5 space-y-4 text-xs">
                            <div><p class="mb-1 font-semibold">1. Time to first cigarette after waking?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="3">Within 5 min (3)</option><option value="2">6-30 min (2)</option><option value="1">31-60 min (1)</option><option value="0" selected>After 60 min (0)</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">2. Hard to refrain in forbidden places?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="1">Yes (1)</option><option value="0" selected>No (0)</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">3. Which cigarette would you hate most to give up?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="1">First one in morning (1)</option><option value="0" selected>Any other (0)</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">4. How many cigarettes per day?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="0" selected>10 or less (0)</option><option value="1">11-20 (1)</option><option value="2">21-30 (2)</option><option value="3">31 or more (3)</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">5. Smoke more during the first hours after waking?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="1">Yes (1)</option><option value="0" selected>No (0)</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">6. Smoke if you are so ill you are in bed?</p>
                                <select onchange="calcFag()" class="fag-q input-field"><option value="1">Yes (1)</option><option value="0" selected>No (0)</option></select>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-2xl overflow-hidden shadow-sm">
                        <div class="bg-purple-700 text-white px-5 py-3 flex justify-between items-center">
                            <span class="font-bold uppercase tracking-wider text-sm">Vape Addiction (V-FTND)</span>
                            <span id="vapeResultDisplay" class="font-black text-lg">0 (Low)</span>
                            <input type="hidden" id="vapeScore" name="vapeScore" value="0 (Low)">
                        </div>
                        <div class="p-5 space-y-4 text-xs">
                            <div><p class="mb-1 font-semibold">1. How soon after waking do you vape?</p>
                                <select onchange="calcVape()" class="vape-q input-field"><option value="3">Within 5 min</option><option value="2">6-30 min</option><option value="1">31-60 min</option><option value="0" selected>After 60 min</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">2. Difficult to stop in non-vaping areas?</p>
                                <select onchange="calcVape()" class="vape-q input-field"><option value="1">Yes</option><option value="0" selected>No</option></select>
                            </div>
                            <div><p class="mb-1 font-semibold">3. Vaping sessions per day?</p>
                                <select onchange="calcVape()" class="vape-q input-field"><option value="0" selected>Low frequency</option><option value="1">Moderate</option><option value="2">High frequency</option></select>
                            </div>
                        </div>
                    </div>
                </div>

                <section class="bg-amber-50 border-2 border-amber-200 rounded-2xl overflow-hidden shadow-sm">
                    <div id="assistHeader" class="bg-amber-600 text-white px-6 py-4 flex justify-between items-center">
                        <span class="font-bold uppercase tracking-widest text-lg">ASSIST Score (Tobacco)</span>
                        <span id="assistResultDisplay" class="font-black text-xl">0 - LOW RISK</span>
                        <input type="hidden" id="assistScore" name="assistScore" value="0 - LOW RISK">
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-xs">
                        <div>
                            <p class="font-bold mb-2">Q1: In the past 3 months, how often have you used tobacco?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">Never (0)</option><option value="3">Once or Twice (3)</option><option value="4">Monthly (4)</option><option value="6">Weekly (6)</option></select>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Q2: How often have you had a strong desire or urge to use?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">Never (0)</option><option value="3">Monthly (3)</option><option value="4">Weekly (4)</option><option value="6">Daily (6)</option></select>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Q3: How often has use led to health, social or legal problems?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">Never (0)</option><option value="5">Yes, but not recently (5)</option><option value="7">Yes, in the last 3 months (7)</option></select>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Q4: Have you failed to do what was expected of you because of use?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">Never (0)</option><option value="5">Yes, but not recently (5)</option><option value="7">Yes, in the last 3 months (7)</option></select>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Q5: Has a friend/relative expressed concern about your use?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">No (0)</option><option value="3">Yes, not recently (3)</option><option value="6">Yes, in the last 3 months (6)</option></select>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Q6: Have you ever tried and failed to control or stop?</p>
                            <select onchange="calcAssist()" class="assist-q input-field"><option value="0">No (0)</option><option value="3">Yes, not recently (3)</option><option value="6">Yes, in the last 3 months (6)</option></select>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-6 bg-white border rounded-xl">
                        <label class="block font-black text-slate-700 mb-2 uppercase text-xs">CO Breath Test (ppm)</label>
                        <input type="number" id="coLevel" name="coLevel" class="w-full text-3xl font-black text-teal-600 border-none outline-none" placeholder="0">
                    </div>
                    <div class="p-6 bg-white border rounded-xl">
                        <label class="block font-black text-slate-700 mb-2 uppercase text-xs">Withdrawal Symptoms</label>
                        <textarea id="withdrawal" name="withdrawal" rows="2" class="input-field border-none text-sm" placeholder="List symptoms..."></textarea>
                    </div>
                </div>

                <section class="bg-teal-50/50 border-2 border-teal-100 p-8 rounded-2xl">
                    <h3 class="font-black text-teal-900 mb-4 uppercase tracking-tighter">Plan of Care & Intervention</h3>
                    <textarea id="plan" name="plan" rows="4" class="input-field mb-6 shadow-inner" placeholder="Counselling notes..."></textarea>
                    
                    <div class="bg-white p-6 rounded-xl border border-teal-200 mb-6">
                        <p class="font-bold text-sm text-teal-800 mb-4">Pharmacotherapy Prescribed:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center space-x-2 text-xs"><input type="checkbox" name="pharma" value="Gum 2mg"> <span>Gum 2mg</span></label>
                            <label class="flex items-center space-x-2 text-xs"><input type="checkbox" name="pharma" value="Gum 4mg"> <span>Gum 4mg</span></label>
                            <label class="flex items-center space-x-2 text-xs"><input type="checkbox" name="pharma" value="Patch 25mg"> <span>Patch 25mg</span></label>
                            <label class="flex items-center space-x-2 text-xs"><input type="checkbox" name="pharma" value="Patch 15mg"> <span>Patch 15mg</span></label>
                        </div>
                    </div>

                    <div class="flex-1">
                        <label class="block font-bold text-teal-800 mb-1 text-xs uppercase">Next TCA Appointment</label>
                        <input type="date" id="tcaDate" name="tcaDate" class="input-field font-bold">
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 no-print pb-10">
                    <button type="button" onclick="nuclearSave()" id="saveBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-black py-5 rounded-2xl shadow-xl transition-all transform hover:scale-[1.02]">
                        ‚òÅÔ∏è SAVE TO CLOUD
                    </button>
                    <button type="button" onclick="saveToWord()" class="bg-blue-700 hover:bg-blue-800 text-white font-black py-5 rounded-2xl shadow-xl">
                        üìÑ SAVE TO WORD
                    </button>
                    <button type="reset" class="bg-white text-red-500 border-2 border-red-100 font-bold py-5 rounded-2xl">
                        üóëÔ∏è CLEAR ALL
                    </button>
                </div>
            </form>
        </div>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted){alert('Sync Successful!');}"></iframe>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlPlXyDuCZXMHA592T2xVaD4MNNFa9aHW26V2k4gxwPF32WRdN3DxvJINYojAD28PBMg/exec'; 
        let submitted = false;

        window.onload = () => {
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            fetchDashboard();
        };

        function calcFag() {
            let s = 0; document.querySelectorAll('.fag-q').forEach(q => s += parseInt(q.value));
            let i = s <= 2 ? "Very Low" : s <= 4 ? "Low" : s <= 6 ? "Moderate" : "High";
            document.getElementById('fagResultDisplay').innerText = `${s} (${i})`;
            document.getElementById('fagerstrom').value = `${s} (${i})`;
        }

        function calcVape() {
            let s = 0; document.querySelectorAll('.vape-q').forEach(q => s += parseInt(q.value));
            let i = s <= 3 ? "Low" : s <= 5 ? "Moderate" : "High";
            document.getElementById('vapeResultDisplay').innerText = `${s} (${i})`;
            document.getElementById('vapeScore').value = `${s} (${i})`;
        }

        function calcAssist() {
            let s = 0; document.querySelectorAll('.assist-q').forEach(q => s += parseInt(q.value));
            let i = "LOW RISK", c = "bg-amber-600";
            if(s >= 4 && s <= 26) { i = "MODERATE RISK"; c = "bg-orange-500"; }
            else if(s >= 27) { i = "HIGH RISK"; c = "bg-red-600"; }
            document.getElementById('assistResultDisplay').innerText = `${s} - ${i}`;
            document.getElementById('assistScore').value = `${s} - ${i}`;
            document.getElementById('assistHeader').className = `${c} text-white px-6 py-4 flex justify-between items-center`;
        }

        function nuclearSave() {
            const btn = document.getElementById('saveBtn');
            if(!document.getElementById('ptName').value) return alert("Please enter Patient Name");
            btn.disabled = true; btn.innerText = "Syncing...";
            
            const form = document.createElement('form');
            form.method = 'POST'; form.action = SCRIPT_URL; form.target = 'hidden_iframe';

            // Collect checkboxes separately
            const pharma = Array.from(document.querySelectorAll('input[name="pharma"]:checked')).map(c => c.value).join(", ");
            
            // Collect all inputs/selects/textareas from the clerkingForm
            const inputs = document.getElementById('clerkingForm').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.name !== 'pharma') {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = input.name;
                    hiddenInput.value = input.value;
                    form.appendChild(hiddenInput);
                }
            });

            // Add the combined pharma list
            const pharmaInput = document.createElement('input');
            pharmaInput.type = 'hidden'; pharmaInput.name = 'pharma'; pharmaInput.value = pharma;
            form.appendChild(pharmaInput);

            document.body.appendChild(form);
            submitted = true;
            form.submit();
            setTimeout(() => { btn.disabled = false; btn.innerText = "‚òÅÔ∏è SAVE TO CLOUD"; fetchDashboard(); }, 2000);
        }

        async function saveToWord() {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
            const pharma = Array.from(document.querySelectorAll('input[name="pharma"]:checked')).map(c => c.value).join(", ");
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "KBM TOOLKIT CLINICAL RECORD", heading: HeadingLevel.HEADING_1 }),
                        new Paragraph({ text: `Patient: ${document.getElementById('ptName').value}`, bold: true }),
                        new Paragraph({ text: `IC: ${document.getElementById('ptIC').value}` }),
                        new Paragraph({ text: `Visit Date: ${document.getElementById('visitDate').value}` }),
                        new Paragraph({ text: `Quit Date: ${document.getElementById('quitDate').value}` }),
                        new Paragraph({ text: `Fagerstr√∂m: ${document.getElementById('fagerstrom').value}` }),
                        new Paragraph({ text: `Vape: ${document.getElementById('vapeScore').value}` }),
                        new Paragraph({ text: `ASSIST: ${document.getElementById('assistScore').value}` }),
                        new Paragraph({ text: `CO Level: ${document.getElementById('coLevel').value} ppm` }),
                        new Paragraph({ text: `Plan: ${document.getElementById('plan').value}` }),
                        new Paragraph({ text: `Medication: ${pharma}` }),
                        new Paragraph({ text: `Next TCA: ${document.getElementById('tcaDate').value}`, bold: true }),
                    ],
                }],
            });
            const blob = await Packer.toBlob(doc);
            saveAs(blob, `KBM_${document.getElementById('ptIC').value || 'Record'}.docx`);
        }

        async function fetchDashboard() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats`);
                const stats = await response.json();
                document.getElementById('dashTotal').innerText = stats.total || 0;
                document.getElementById('dashHighRisk').innerText = stats.highRisk || 0;
            } catch (e) { console.log("Stats fetch blocked by firewall."); }
        }

        async function searchPatient() {
            const query = document.getElementById('searchQuery').value;
            if(!query) return;
            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                if(data.found) {
                    document.getElementById('ptName').value = data.name;
                    document.getElementById('ptIC').value = data.ic;
                    document.getElementById('quitDate').value = data.quitDate;
                    document.getElementById('visitNo').value = parseInt(data.lastVisit || 0) + 1;
                    alert("Record Found and Auto-filled.");
                } else { alert("No patient found."); }
            } catch (e) { alert("Search restricted by firewall."); }
        }
    </script>
</body>
</html>