<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBM TOOLKIT - First TCA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-field { background-color: #f8fafc; transition: all 0.2s; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.625rem; outline: none; width: 100%; }
        .input-field:focus { background-color: #ffffff; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .section-card { background-color: white; border-radius: 0.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); overflow: hidden; margin-bottom: 2rem; }
        .section-header { background-color: #f1f5f9; padding: 0.75rem 1.25rem; border-bottom: 1px solid #e2e8f0; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen py-6 sm:py-10 px-4">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-slate-200">
        
        <div class="bg-teal-800 text-white p-6 sm:p-8 text-center relative">
            <h1 class="text-2xl sm:text-3xl font-extrabold uppercase tracking-wide">FIRST TCA KBM CLERKING SHEET</h1>
            <p class="text-teal-100 text-sm mt-2">Klinik Berhenti Merokok (KBM) - New Case Entry</p>
        </div>

        <form id="clerkingForm" class="p-6 sm:p-8">

            <section class="section-card">
                <div class="section-header"><h2 class="text-sm font-bold text-gray-600 uppercase">Patient Details</h2></div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Name (Nama)</label>
                        <input type="text" id="ptName" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">IC Number (No. KP)</label>
                        <input type="text" id="ptIC" class="input-field font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Gender (Jantina)</label>
                        <select id="gender" class="input-field">
                            <option value="">Sila Pilih</option>
                            <option value="Lelaki">Lelaki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Phone Number</label>
                        <input type="text" id="ptPhone" class="input-field font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Referral From</label>
                        <input type="text" id="referral" class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Alamat (Address)</label>
                        <textarea id="ptAddress" rows="2" class="input-field"></textarea>
                    </div>
                </div>
            </section>

            <section class="section-card p-5 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3 uppercase">Medical Illness (Penyakit)</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2"><input type="checkbox" class="med-illness" value="Asthma"> <span>Asthma</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="med-illness" value="IHD"> <span>IHD</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="med-illness" value="DM"> <span>DM</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="med-illness" value="HPT"> <span>HPT</span></label>
                        <div class="col-span-2 flex items-center space-x-2">
                            <span class="text-xs font-bold text-gray-400">Others:</span>
                            <input type="text" id="illnessOthers" class="border-b border-gray-300 outline-none flex-1 text-sm">
                        </div>
                    </div>
                </div>
                <hr class="border-gray-100">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3 uppercase">Jenis Rokok (Type of Smoking)</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2"><input type="checkbox" class="smoke-type" value="Conventional"> <span>Conventional</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="smoke-type" value="Vape"> <span>Vape</span></label>
                        <div class="col-span-2 flex items-center space-x-2">
                            <span class="text-xs font-bold text-gray-400">Others:</span>
                            <input type="text" id="smokeOthers" class="border-b border-gray-300 outline-none flex-1 text-sm">
                        </div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-white p-4 rounded-lg border border-slate-200">
                    <label class="font-bold text-gray-700 block mb-1 uppercase text-xs">Date of Visit</label>
                    <input type="date" id="date" class="input-field">
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200">
                    <label class="font-bold text-gray-700 block mb-1 uppercase text-xs">Quit Date</label>
                    <input type="date" id="quitDate" class="input-field">
                </div>
            </div>

            <section class="bg-blue-50 rounded-lg border border-blue-100 p-5 overflow-hidden mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-blue-900 uppercase">Cigarette Score (FTND)</h2>
                    <div class="text-right">
                        <span id="scoreDisplay" class="text-2xl font-bold text-blue-800">0</span>
                        <span id="dependenceDisplay" class="text-sm text-blue-600 block">(Very Low)</span>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-blue-100 space-y-5 text-sm">
                    <div>
                        <p class="font-semibold mb-2">1. How soon after you wake up do you smoke your first cigarette?</p>
                        <select name="f1" onchange="calculateFagerstrom()" class="input-field">
                            <option value="3">Within 5 mins [3]</option>
                            <option value="2">6-30 mins [2]</option>
                            <option value="1">31-60 mins [1]</option>
                            <option value="0" selected>After 60 mins [0]</option>
                        </select>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">2. Difficult to refrain from smoking in forbidden places?</p>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2"><input type="radio" name="f2" value="1" onchange="calculateFagerstrom()"> <span>Yes [1]</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="f2" value="0" checked onchange="calculateFagerstrom()"> <span>No [0]</span></label>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">3. Which cigarette would you hate most to give up?</p>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2"><input type="radio" name="f3" value="1" onchange="calculateFagerstrom()"> <span>First one in AM [1]</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="f3" value="0" checked onchange="calculateFagerstrom()"> <span>Any other [0]</span></label>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">4. How many cigarettes/day do you smoke?</p>
                        <select name="f4" onchange="calculateFagerstrom()" class="input-field">
                            <option value="0" selected>10 or less [0]</option>
                            <option value="1">11-20 [1]</option>
                            <option value="2">21-30 [2]</option>
                            <option value="3">31 or more [3]</option>
                        </select>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">5. Do you smoke more frequently first hours after waking?</p>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2"><input type="radio" name="f5" value="1" onchange="calculateFagerstrom()"> <span>Yes [1]</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="f5" value="0" checked onchange="calculateFagerstrom()"> <span>No [0]</span></label>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">6. Smoke if you are so ill you are in bed most of day?</p>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2"><input type="radio" name="f6" value="1" onchange="calculateFagerstrom()"> <span>Yes [1]</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="f6" value="0" checked onchange="calculateFagerstrom()"> <span>No [0]</span></label>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-purple-50 rounded-lg border border-purple-100 p-5 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-purple-900 uppercase">Vape Score (E-FTND)</h2>
                    <div class="text-right">
                        <span id="vapeScoreDisplay" class="text-2xl font-bold text-purple-800">0</span>
                        <span id="vapeDepDisplay" class="text-sm text-purple-600 block">(Low Dependence)</span>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-purple-100 space-y-5 text-sm">
                    <div>
                        <p class="font-semibold mb-2">1. How soon after waking do you first use your vape?</p>
                        <select name="v1" onchange="calculateVapeScore()" class="input-field">
                            <option value="3">Within 5 mins [3]</option>
                            <option value="2">6-30 mins [2]</option>
                            <option value="1">31-60 mins [1]</option>
                            <option value="0" selected>After 60 mins [0]</option>
                        </select>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">2. Difficult to stop vaping in restricted places?</p>
                        <div class="flex space-x-6">
                            <label class="flex items-center space-x-2"><input type="radio" name="v2" value="1" onchange="calculateVapeScore()"> <span>Yes [1]</span></label>
                            <label class="flex items-center space-x-2"><input type="radio" name="v2" value="0" checked onchange="calculateVapeScore()"> <span>No [0]</span></label>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">3. How many vaping sessions per day?</p>
                        <select name="v3" onchange="calculateVapeScore()" class="input-field">
                            <option value="0" selected>10 or less [0]</option>
                            <option value="1">11-20 [1]</option>
                            <option value="2">21-30 [2]</option>
                            <option value="3">31 or more [3]</option>
                        </select>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <section class="section-card p-5">
                    <label class="text-xs font-bold uppercase text-gray-500 block mb-2">Smoking History</label>
                    <div class="space-y-3">
                        <input type="number" id="cigarettes" placeholder="Sticks per day" oninput="calculatePackYears()" class="input-field">
                        <input type="number" id="smokingYears" placeholder="Years smoked" oninput="calculatePackYears()" class="input-field">
                        <div class="p-2 bg-slate-800 text-white rounded text-center text-xs font-bold">Pack Years: <span id="packYearsDisplay">0</span></div>
                    </div>
                </section>
                <section class="section-card p-5">
                    <label class="text-xs font-bold uppercase text-gray-500 block mb-2">CO Level (ppm)</label>
                    <input type="number" id="coLevel" class="input-field text-2xl text-center text-teal-700 font-bold" placeholder="0">
                </section>
            </div>

            <section class="section-card overflow-hidden border-yellow-200 mb-8">
                <div class="bg-yellow-50 px-5 py-3 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-900 uppercase">Pharmacotherapy</h2></div>
                <div class="p-5">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Prescribe Medication?</label>
                    <div class="flex items-center space-x-6 mb-3">
                        <label class="cursor-pointer"><input type="radio" name="pharmaOpt" value="no" checked onchange="togglePharma(false)"> No</label>
                        <label class="cursor-pointer"><input type="radio" name="pharmaOpt" value="yes" onchange="togglePharma(true)"> Yes</label>
                    </div>
                    <div id="pharmaDetailsDiv" class="hidden space-y-4 pt-3 border-t border-dashed border-gray-200">
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <label class="text-xs flex items-center space-x-1"><input type="checkbox" class="pharma-item" value="Gum 2mg"> <span>Gum 2mg</span></label>
                            <label class="text-xs flex items-center space-x-1"><input type="checkbox" class="pharma-item" value="Gum 4mg"> <span>Gum 4mg</span></label>
                            <label class="text-xs flex items-center space-x-1"><input type="checkbox" class="pharma-item" value="Patch 25mg"> <span>Patch 25mg</span></label>
                            <label class="text-xs flex items-center space-x-1"><input type="checkbox" class="pharma-item" value="Patch 15mg"> <span>Patch 15mg</span></label>
                            <label class="text-xs flex items-center space-x-1"><input type="checkbox" class="pharma-item" value="Patch 10mg"> <span>Patch 10mg</span></label>
                        </div>
                        <input type="text" id="pharmaOther" placeholder="Other notes/dosage..." class="input-field text-xs">
                    </div>
                </div>
            </section>

            <section class="section-card p-5 mb-8">
                <label class="font-bold block mb-2 uppercase text-xs text-gray-500">Plan of Care</label>
                <textarea id="plan" rows="3" class="input-field" placeholder="Counseling goals..."></textarea>
            </section>
            <section class="section-card p-5 mb-8">
                <label class="font-bold block mb-2 uppercase text-xs text-gray-500">Next TCA</label>
                <input type="date" id="tcaDate" class="input-field w-auto">
            </section>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 no-print border-t border-gray-100">
                <button type="button" id="saveBtn" onclick="saveToGoogleSheet()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">‚òÅÔ∏è Save to Cloud</button>
                <button type="button" onclick="exportToWord()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">üìù Save as Word</button>
                <button type="button" onclick="handleClearClick()" class="bg-white border-2 border-red-100 text-red-600 font-bold py-3 px-4 rounded-lg shadow-sm">üóëÔ∏è Clear Form</button>
            </div>
        </form>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkTzQ-Kxdhm7n1hGQEo1Qh_6GI0sqxbx6LqZVU8y5kF5kgIV3nTRvAY3ps2UKFRb5NQg/exec';

        window.onload = function() { document.getElementById('date').value = new Date().toISOString().split('T')[0]; };

        function togglePharma(show) { document.getElementById('pharmaDetailsDiv').classList.toggle('hidden', !show); }

        function calculatePackYears() {
            const cigs = parseFloat(document.getElementById('cigarettes').value) || 0;
            const years = parseFloat(document.getElementById('smokingYears').value) || 0;
            document.getElementById('packYearsDisplay').innerText = ((cigs / 20) * years).toFixed(1);
        }

        function calculateFagerstrom() {
            let score = 0;
            const f1 = parseInt(document.querySelector('select[name="f1"]').value) || 0;
            const f2 = parseInt(document.querySelector('input[name="f2"]:checked')?.value) || 0;
            const f3 = parseInt(document.querySelector('input[name="f3"]:checked')?.value) || 0;
            const f4 = parseInt(document.querySelector('select[name="f4"]').value) || 0;
            const f5 = parseInt(document.querySelector('input[name="f5"]:checked')?.value) || 0;
            const f6 = parseInt(document.querySelector('input[name="f6"]:checked')?.value) || 0;
            score = f1 + f2 + f3 + f4 + f5 + f6;
            document.getElementById('scoreDisplay').innerText = score;
            let dep = (score <= 2) ? "Very Low" : (score <= 4) ? "Low" : (score <= 5) ? "Moderate" : (score <= 7) ? "High" : "Very High";
            document.getElementById('dependenceDisplay').innerText = `(${dep})`;
        }

        function calculateVapeScore() {
            let score = 0;
            const v1 = parseInt(document.querySelector('select[name="v1"]').value) || 0;
            const v2 = parseInt(document.querySelector('input[name="v2"]:checked')?.value) || 0;
            const v3 = parseInt(document.querySelector('select[name="v3"]').value) || 0;
            score = v1 + v2 + v3;
            document.getElementById('vapeScoreDisplay').innerText = score;
            let dep = (score <= 2) ? "Low Dependence" : (score <= 4) ? "Moderate Dependence" : "High Dependence";
            document.getElementById('vapeDepDisplay').innerText = `(${dep})`;
        }

        function getMultiValue(className, otherId) {
            let selected = [];
            document.querySelectorAll('.' + className + ':checked').forEach(cb => selected.push(cb.value));
            if(otherId) {
                const other = document.getElementById(otherId).value;
                if(other) selected.push(other);
            }
            return selected.join(", ");
        }

        async function saveToGoogleSheet() {
            const btn = document.getElementById('saveBtn');
            if(!document.getElementById('ptName').value) { alert("Sila masukkan Nama Pesakit"); return; }
            btn.disabled = true; btn.innerHTML = "Saving...";
            const params = new URLSearchParams();
            params.append('ptName', document.getElementById('ptName').value);
            params.append('ptIC', document.getElementById('ptIC').value);
            params.append('gender', document.getElementById('gender').value);
            params.append('ptPhone', document.getElementById('ptPhone').value);
            params.append('ptAddress', document.getElementById('ptAddress').value);
            params.append('referral', document.getElementById('referral').value);
            params.append('medicalIllness', getMultiValue('med-illness', 'illnessOthers'));
            params.append('smokingType', getMultiValue('smoke-type', 'smokeOthers'));
            params.append('date', document.getElementById('date').value);
            params.append('quitDate', document.getElementById('quitDate').value);
            params.append('fagerstromScore', document.getElementById('scoreDisplay').innerText);
            params.append('fagerstromDep', document.getElementById('dependenceDisplay').innerText);
            params.append('vapeScore', document.getElementById('vapeScoreDisplay').innerText);
            params.append('vapeDep', document.getElementById('vapeDepDisplay').innerText);
            params.append('cigarettesPerDay', document.getElementById('cigarettes').value);
            params.append('smokingYears', document.getElementById('smokingYears').value);
            params.append('packYears', document.getElementById('packYearsDisplay').innerText);
            params.append('coLevel', document.getElementById('coLevel').value);
            params.append('plan', document.getElementById('plan').value);
            params.append('pharma', getMultiValue('pharma-item', 'pharmaOther'));
            params.append('tcaDate', document.getElementById('tcaDate').value);
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: params.toString() });
                alert("Data Berjaya Disimpan ke Google Sheet!");
            } catch (e) { alert("Error Saving!"); }
            finally { btn.disabled = false; btn.innerHTML = "‚òÅÔ∏è Save to Cloud"; }
        }

        function handleClearClick() { if(confirm("Hapus semua data dalam borang?")) document.getElementById('clerkingForm').reset(); }

        function exportToWord() {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
            const ptName = document.getElementById('ptName').value || "Unnamed";
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "KBM CLERKING REPORT", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: "" }),
                        new Paragraph({ children: [new TextRun({ text: `Patient Name: ${ptName}`, bold: true })] }),
                        new Paragraph({ text: `IC: ${document.getElementById('ptIC').value}` }),
                        new Paragraph({ text: `Visit Date: ${document.getElementById('date').value}` }),
                        new Paragraph({ text: "" }),
                        new Paragraph({ children: [new TextRun({ text: "ADDICTION ASSESSMENT", bold: true, underline: true })] }),
                        new Paragraph({ text: `Cigarette Score (FTND): ${document.getElementById('scoreDisplay').innerText} ${document.getElementById('dependenceDisplay').innerText}` }),
                        new Paragraph({ text: `Vape Score (E-FTND): ${document.getElementById('vapeScoreDisplay').innerText} ${document.getElementById('vapeDepDisplay').innerText}` }),
                        new Paragraph({ text: `CO Level: ${document.getElementById('coLevel').value} ppm | Pack Years: ${document.getElementById('packYearsDisplay').innerText}` }),
                        new Paragraph({ text: "" }),
                        new Paragraph({ children: [new TextRun({ text: "MANAGEMENT PLAN", bold: true, underline: true })] }),
                        new Paragraph({ text: `Quit Date: ${document.getElementById('quitDate').value}` }),
                        new Paragraph({ text: `Pharmacotherapy: ${getMultiValue('pharma-item', 'pharmaOther')}` }),
                        new Paragraph({ text: `Plan: ${document.getElementById('plan').value}` }),
                        new Paragraph({ text: `Next TCA: ${document.getElementById('tcaDate').value}` }),
                    ],
                }],
            });
            Packer.toBlob(doc).then(blob => { saveAs(blob, `KBM_Clerking_${ptName}.docx`); });
        }
    </script>
</body>
</html>